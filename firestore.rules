rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Communities collection - anyone can read, only authenticated users can create
    match /communities/{communityId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update: if request.auth != null && (request.resource.data.creatorId == request.auth.uid || resource.data.creatorId == request.auth.uid);
      allow delete: if request.auth != null && resource.data.creatorId == request.auth.uid;
    }
    
    // Posts collection
    match /posts/{postId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update: if (request.auth != null && (request.resource.data.authorId == request.auth.uid || resource.data.authorId == request.auth.uid)) || (request.resource.data.views == resource.data.views + 1);
      // Only the author can delete their own posts
      // Exception: Posts without authorId (legacy/test posts) can be deleted by any authenticated user for cleanup
      allow delete: if request.auth != null && (resource.data.authorId == request.auth.uid || !resource.data.authorId);
    }
    
    // Users collection
    match /users/{userId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == userId;
      match /notifications/{notificationId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow create: if request.auth != null;
        allow update, delete: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // Comments on posts
    match /posts/{postId}/comments/{commentId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && (request.resource.data.authorId == request.auth.uid || resource.data.authorId == request.auth.uid);
    }
    
    // Prayers collection
    match /prayers/{prayerId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && (request.resource.data.authorId == request.auth.uid || resource.data.authorId == request.auth.uid);
    }
    
    // Prayer Requests collection
    match /prayer_requests/{requestId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update: if request.auth != null && (request.resource.data.authorId == request.auth.uid || resource.data.authorId == request.auth.uid);
      // Only the author can delete their own prayer requests
      // Exception: Requests without authorId (legacy/test requests) can be deleted by any authenticated user for cleanup
      allow delete: if request.auth != null && (resource.data.authorId == request.auth.uid || !resource.data.authorId);
    }
    
    // Partner Prayers collection
    match /partner_prayers/{prayerId} {
      allow read: if true;
      allow create: if request.auth != null;
      // Allow author to update/delete their own content
      // Also allow ANY authenticated user to update selectedDate and isSelected (for scheduling)
      allow update: if request.auth != null && (
        (request.resource.data.authorId == request.auth.uid || resource.data.authorId == request.auth.uid) ||
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['selectedDate', 'isSelected']) && 
         request.resource.data.authorId == resource.data.authorId)
      );
      allow delete: if request.auth != null && (request.resource.data.authorId == request.auth.uid || resource.data.authorId == request.auth.uid);
    }
    
    // Partner Words collection
    match /partner_words/{wordId} {
      allow read: if true;
      allow create: if request.auth != null;
      // Allow author to update/delete their own content
      // Also allow ANY authenticated user to update selectedDate and isSelected (for scheduling)
      allow update: if request.auth != null && (
        (request.resource.data.authorId == request.auth.uid || resource.data.authorId == request.auth.uid) ||
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['selectedDate', 'isSelected']) && 
         request.resource.data.authorId == resource.data.authorId)
      );
      allow delete: if request.auth != null && (request.resource.data.authorId == request.auth.uid || resource.data.authorId == request.auth.uid);
    }
    
    // Partner Scriptures collection
    match /partner_scriptures/{scriptureId} {
      allow read: if true;
      allow create: if request.auth != null;
      // Allow author to update/delete their own content
      // Also allow ANY authenticated user to update selectedDate and isSelected (for scheduling)
      allow update: if request.auth != null && (
        (request.resource.data.authorId == request.auth.uid || resource.data.authorId == request.auth.uid) ||
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['selectedDate', 'isSelected']) && 
         request.resource.data.authorId == resource.data.authorId)
      );
      allow delete: if request.auth != null && (request.resource.data.authorId == request.auth.uid || resource.data.authorId == request.auth.uid);
    }
    
    // Comments on prayers
    match /prayers/{prayerId}/comments/{commentId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && (request.resource.data.authorId == request.auth.uid || resource.data.authorId == request.auth.uid);
    }
    
    // Comments on prayer requests
    match /prayer_requests/{requestId}/comments/{commentId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && (request.resource.data.authorId == request.auth.uid || resource.data.authorId == request.auth.uid);
    }
    
    // Prayer Reminders collection - users can only read/write their own reminders
    match /prayer_reminders/{reminderId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }
    
    // Mail collection - for Trigger Email extension (Cloud Functions only)
    match /mail/{mailId} {
      allow read: if false;
      allow create: if false;
      allow update, delete: if false;
    }
  }
}

